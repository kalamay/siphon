checkout:
  post:
    - git submodule sync
    - git submodule update --init
dependencies:
  cache_directories:
    - ~/dep
  pre:
    - >-
      if [[ ! -e $HOME/dep/cmake-3.4.1/bin/cmake ]]; then \
        mkdir -p "$HOME/dep"; cd "$HOME/dep" \
        && curl -O https://cmake.org/files/v3.4/cmake-3.4.1.tar.gz \
        && tar xvzf cmake-3.4.1.tar.gz \
        && cd cmake-3.4.1 \
        && ./bootstrap \
        && make \
      ; fi
    - >-
      if [[ ! -e $HOME/dep/ragel-6.9/ragel/ragel ]]; then \
        mkdir -p "$HOME/dep"; cd "$HOME/dep" \
        && curl -O http://www.colm.net/files/ragel/ragel-6.9.tar.gz \
        && tar xvzf ragel-6.9.tar.gz \
        && cd ragel-6.9 \
        && ./configure \
        && make \
      ; fi
test:
  override:
    - rm -rf build
    - $HOME/dep/cmake-3.4.1/bin/cmake -H. -Bbuild -DCMAKE_C_COMPILER=$(which gcc-4.9) -DCMAKE_BUILD_TYPE=Debug -DRAGEL_COMMAND=$HOME/dep/ragel-6.9/ragel/ragel
    - $HOME/dep/cmake-3.4.1/bin/cmake --build build
    - cd build && $HOME/dep/cmake-3.4.1/bin/ctest -T test --output-on-failure . || /usr/bin/true
    - xsltproc test/CTest2JUnit.xsl build/Testing/$(head -n 1 < build/Testing/TAG)/Test.xml > $CIRCLE_TEST_REPORTS/siphon.xml
